// Função para alternar entre Pessoa Física (CPF) e Empresa (CNPJ)
function setRegime(regime) {
    const btnCpf = document.getElementById('btnCpf');
    const btnCnpj = document.getElementById('btnCnpj');
    const inputTax = document.getElementById('feeTax');
    const inputFixed = document.getElementById('feeFixed');
    const labelFixed = document.getElementById('labelFixed');

    if(regime === 'cpf') {
        btnCpf.classList.add('active');
        btnCnpj.classList.remove('active');
        
        inputTax.value = 0;
        inputTax.style.background = 'var(--input-bg)';
        
        inputFixed.value = 7.00; 
        inputFixed.style.background = 'rgba(255, 55, 95, 0.2)'; 
        labelFixed.style.color = 'var(--accent)';
        
        setTimeout(() => {
            inputFixed.style.background = 'var(--input-bg)';
            labelFixed.style.color = 'var(--text-muted)';
        }, 800);

    } else {
        btnCnpj.classList.add('active');
        btnCpf.classList.remove('active');
        
        inputTax.value = 0; 
        inputTax.style.background = 'rgba(255, 255, 255, 0.15)'; 
        
        inputFixed.value = 4.00; 
        inputFixed.style.background = 'rgba(48, 209, 88, 0.2)'; 
        labelFixed.style.color = 'var(--success)';
        
        setTimeout(() => {
            inputFixed.style.background = 'var(--input-bg)';
            labelFixed.style.color = 'var(--text-muted)';
        }, 800);
    }
    
    if (document.getElementById('resultsArea').style.display === 'block') {
        calculate();
    }
}

// Atualiza o texto da etiqueta dependendo do modo de precificação escolhido
document.getElementById('pricingMode').addEventListener('change', function() {
    const mode = this.value;
    const label = document.getElementById('targetLabel');
    if(mode === 'margin') label.innerText = 'Margem Desejada (%)';
    if(mode === 'price') label.innerText = 'Preço Final (R$)';
    if(mode === 'profit') label.innerText = 'Lucro Desejado (R$)';
});

// Variável global para armazenar os dados e compartilhar no WhatsApp
let globalResults = {};

// Função principal de cálculo
function calculate() {
    const costProduct = parseFloat(document.getElementById('costProduct').value) || 0;
    const costPackaging = parseFloat(document.getElementById('costPackaging').value) || 0;
    const feeCommission = (parseFloat(document.getElementById('feeCommission').value) || 0) / 100;
    const feeTax = (parseFloat(document.getElementById('feeTax').value) || 0) / 100;
    const feeFixed = parseFloat(document.getElementById('feeFixed').value) || 0;
    const feeShipping = parseFloat(document.getElementById('feeShipping').value) || 0;
    
    const mode = document.getElementById('pricingMode').value;
    const targetValue = parseFloat(document.getElementById('targetValue').value) || 0;
    const inputRoas = parseFloat(document.getElementById('inputRoas').value) || 0;

    const fixedCosts = costProduct + costPackaging + feeFixed + feeShipping;
    const variableFeesPercentage = feeCommission + feeTax;

    let salePrice = 0, netProfit = 0, profitMargin = 0;

    if (mode === 'margin') {
        const margin = targetValue / 100;
        salePrice = fixedCosts / (1 - variableFeesPercentage - margin);
        netProfit = salePrice * margin;
        profitMargin = margin;
    } else if (mode === 'price') {
        salePrice = targetValue;
        netProfit = salePrice - fixedCosts - (salePrice * variableFeesPercentage);
        profitMargin = salePrice > 0 ? (netProfit / salePrice) : 0;
    } else if (mode === 'profit') {
        netProfit = targetValue;
        salePrice = (fixedCosts + netProfit) / (1 - variableFeesPercentage);
        profitMargin = salePrice > 0 ? (netProfit / salePrice) : 0;
    }

    const roasBox = document.getElementById('roasBox');
    const roasStatus = document.getElementById('roasStatus');
    const roasMargin = document.getElementById('roasMargin');
    const resIdealRoas = document.getElementById('resIdealRoas');

    const marginForAds = profitMargin - 0.10;
    let idealRoasDisplay = marginForAds > 0 ? (1 / marginForAds).toFixed(2) : "Impossível (Aumente o Preço)";
    resIdealRoas.innerText = idealRoasDisplay;

    let finalProfitMargin = profitMargin;
    let statusText = "Insira seu ROAS";
    let subText = "Para ver quanto lucro sobra de verdade.";

    if (inputRoas > 0) {
        const adSpendPercent = 1 / inputRoas;
        finalProfitMargin = profitMargin - adSpendPercent;
        const finalProfitValue = salePrice * finalProfitMargin;

        subText = `Lucro após Ads: ${(finalProfitMargin * 100).toFixed(2)}% (${finalProfitValue.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})`;

        if (finalProfitMargin >= 0.10) {
            roasBox.className = 'roas-box status-good';
            statusText = "?? ROAS Excelente!";
        } else if (finalProfitMargin > 0) {
            roasBox.className = 'roas-box status-warning';
            statusText = "?? Atenção! Lucro Baixo";
        } else {
            roasBox.className = 'roas-box status-bad';
            statusText = "?? Prejuízo!";
        }
    } else {
        roasBox.className = 'roas-box status-empty';
    }

    roasStatus.innerText = statusText;
    roasMargin.innerText = subText;

    globalResults = {
        costProduct, costPackaging, 
        commissionVal: salePrice * feeCommission,
        taxVal: salePrice * feeTax,
        feeFixed, feeShipping, salePrice, netProfit,
        marginBase: profitMargin * 100, 
        roasUser: inputRoas,
        marginReal: finalProfitMargin * 100,
        statusText: statusText
    };

    document.getElementById('resSalePrice').innerText = salePrice.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    document.getElementById('resNetProfit').innerText = netProfit.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    document.getElementById('resMargin').innerText = (profitMargin * 100).toFixed(2) + '%';
    
    document.getElementById('resultsArea').style.display = 'block';
}

// Função para formatar e enviar dados para o WhatsApp
function shareWhatsApp() {
    const brl = (val) => val.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    
    let text = `*Resumo de Precificação*\n\n?? *Custos:*\n- Produção: ${brl(globalResults.costProduct)}\n- Embalagem: ${brl(globalResults.costPackaging)}\n\n?? *Taxas:*\n- Comissão Plataforma: ${brl(globalResults.commissionVal)}\n`;
    
    if(globalResults.taxVal > 0) text += `- Imposto NF: ${brl(globalResults.taxVal)}\n`;
    
    text += `- Frete: ${brl(globalResults.feeShipping)}\n- Taxa Fixa: ${brl(globalResults.feeFixed)}\n\n?? *Resultados Base:*\n- *Preço de Venda:* ${brl(globalResults.salePrice)}\n- Lucro (Sem Ads): ${brl(globalResults.netProfit)} (${globalResults.marginBase.toFixed(2)}%)\n\n?? *Diagnóstico de Ads:*\n`;

    if (globalResults.roasUser > 0) {
        text += `- ROAS Aplicado: ${globalResults.roasUser}\n- Status: ${globalResults.statusText}\n- *Lucro Final (Livre):* ${globalResults.marginReal.toFixed(2)}%`;
    } else {
        text += `- Nenhum ROAS calculado.`;
    }

    navigator.clipboard.writeText(text).then(() => {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(whatsappUrl, '_blank');
    }).catch(() => {
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    });
}